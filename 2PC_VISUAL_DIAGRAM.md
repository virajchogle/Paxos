# Two-Phase Commit Visual Diagram
## Cross-Shard Transaction Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                                     â”‚
â”‚    Cluster 1 (C1)              Cluster 2 (C2)              Cluster 3 (C3)          â”‚
â”‚    Coordinator                 Participant                 Not Involved            â”‚
â”‚                                                                                     â”‚
â”‚    â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”          â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”          â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”      â”‚
â”‚    â”‚ â–“ â”‚ â”‚   â”‚ â”‚   â”‚          â”‚ â–“ â”‚ â”‚   â”‚ â”‚   â”‚          â”‚   â”‚ â”‚   â”‚ â”‚   â”‚      â”‚
â”‚    â”‚ â–“ â”‚ â”‚   â”‚ â”‚   â”‚          â”‚ â–“ â”‚ â”‚   â”‚ â”‚   â”‚          â”‚   â”‚ â”‚   â”‚ â”‚   â”‚      â”‚
â”‚    â”‚ â–“ â”‚ â”‚   â”‚ â”‚   â”‚          â”‚ â–“ â”‚ â”‚   â”‚ â”‚   â”‚          â”‚   â”‚ â”‚   â”‚ â”‚   â”‚      â”‚
â”‚    â””â”€â”¬â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜          â””â”€â”¬â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜          â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜      â”‚
â”‚      ğŸ‘‘                           ğŸ‘‘                                                â”‚
â”‚    Node 1  Node 2  Node 3      Node 4  Node 5  Node 6    Node 7  Node 8  Node 9  â”‚
â”‚   (Leader)                     (Leader)                                            â”‚
â”‚                                                                                     â”‚
â”‚    Items: 1001, 1002, ...      Items: 3001, 3002, ...    Items: 5001, 5002, ...  â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

        ğŸ‘¤
      Client
        â”‚
        â”‚ Transaction: 1001 â†’ 3001, amount: 10
        â”‚ (sender in C1, receiver in C2)
        â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”
    â”‚Node 1 â”‚
    â”‚ (C1)  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                              PHASE 0: PRE-CHECKS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    Coordinator (Node 1, C1 Leader)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         â”‚
         â”‚ â‘  Check duplicate
         â”‚ â‘¡ Check balance[1001] >= 10 âœ“
         â”‚ â‘¢ Lock item 1001 ğŸ”’
         â”‚ â‘£ Save WAL: {1001: 100}
         â”‚
         â†“

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                            PHASE 1: PREPARE (PARALLEL!)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                                     â”‚
â”‚   Cluster 1 (C1)                              Cluster 2 (C2)                       â”‚
â”‚   Coordinator                                 Participant                           â”‚
â”‚                                                                                     â”‚
â”‚      ğŸ‘¤                                                                             â”‚
â”‚    Client                                                                           â”‚
â”‚      â”‚                                                                              â”‚
â”‚      â”‚ Transaction                                                                  â”‚
â”‚      â”‚ 1001â†’3001:10                                                                 â”‚
â”‚      â†“                                                                              â”‚
â”‚   â•”â•â•â•â•â•â•â•â•—                                                                         â”‚
â”‚   â•‘ Node 1â•‘â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â¶ TwoPCPrepare â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â•”â•â•â•â•â•â•â•â•—                   â”‚
â”‚   â•‘  ğŸ‘‘   â•‘              (non-blocking RPC)             â•‘ Node 4â•‘                   â”‚
â”‚   â•šâ•â•â•â•¤â•â•â•â•                                             â•‘  ğŸ‘‘   â•‘                   â”‚
â”‚       â”‚                                                 â•šâ•â•â•â•¤â•â•â•â•                   â”‚
â”‚       â”‚                                                     â”‚                       â”‚
â”‚       â”‚                                                     â”‚                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                                           â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ GOROUTINE 1                                         â”‚ Receive  â”‚                 â”‚
â”‚  â”‚ (Coordinator's Paxos)                               â”‚ PREPARE  â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                 â”‚
â”‚       â”‚                                                     â”‚                       â”‚
â”‚       â”‚ Allocate seq=100                                   â”‚ Check lock on 3001    â”‚
â”‚       â”‚                                                     â”‚ Lock item 3001 ğŸ”’     â”‚
â”‚       â†“                                                     â”‚ Save WAL: {3001: 50}  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚                       â”‚
â”‚  â”‚ Phase=P â”‚                                                â†“                       â”‚
â”‚  â”‚ Seq=100 â”‚                                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                           â”‚ Phase=P â”‚                 â”‚
â”‚       â”‚                                                â”‚ Seq=200 â”‚                 â”‚
â”‚       â†“                                                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                 â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•—                                            â”‚                       â”‚
â”‚  â•‘   ACCEPT    â•‘                                            â†“                       â”‚
â”‚  â•‘  (Phase=P)  â•‘                                       â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•—             â”‚
â”‚  â•šâ•â•â•â•â•â•â•¤â•â•â•â•â•â•â•                                       â•‘   ACCEPT    â•‘             â”‚
â”‚       â”Œâ”€â”´â”€â”                                            â•‘  (Phase=P)  â•‘             â”‚
â”‚       â†“   â†“                                            â•šâ•â•â•â•â•â•â•¤â•â•â•â•â•â•â•             â”‚
â”‚    Node2 Node3                                              â”Œâ”€â”´â”€â”                   â”‚
â”‚       â”‚   â”‚                                                 â†“   â†“                   â”‚
â”‚       â”‚   â”‚ Store entry                                  Node5 Node6               â”‚
â”‚       â”‚   â”‚ Phase=P                                         â”‚   â”‚                   â”‚
â”‚       â”‚   â”‚ Save WAL                                        â”‚   â”‚ Store entry       â”‚
â”‚       â””â”€â”€â”€â”´â”€â†’ AcceptedReply                                â”‚   â”‚ Phase=P           â”‚
â”‚       â”‚                                                     â”‚   â”‚ Save WAL          â”‚
â”‚       â”‚ âœ… Quorum (2/3)                                     â””â”€â”€â”€â”´â†’ AcceptedReply    â”‚
â”‚       â†“                                                     â”‚                       â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•—                                            â”‚ âœ… Quorum (2/3)       â”‚
â”‚  â•‘   COMMIT    â•‘                                            â†“                       â”‚
â”‚  â•‘  (Phase=P)  â•‘                                       â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•—             â”‚
â”‚  â•šâ•â•â•â•â•â•â•¤â•â•â•â•â•â•â•                                       â•‘   COMMIT    â•‘             â”‚
â”‚       â”Œâ”€â”´â”€â”                                            â•‘  (Phase=P)  â•‘             â”‚
â”‚       â†“   â†“                                            â•šâ•â•â•â•â•â•â•¤â•â•â•â•â•â•â•             â”‚
â”‚    Node2 Node3                                              â”Œâ”€â”´â”€â”                   â”‚
â”‚       â”‚   â”‚                                                 â†“   â†“                   â”‚
â”‚       â”‚   â”‚ Execute txn                                  Node5 Node6               â”‚
â”‚       â”‚   â”‚ balance[1001]                                   â”‚   â”‚                   â”‚
â”‚       â”‚   â”‚    100 â†’ 90                                     â”‚   â”‚ Execute txn       â”‚
â”‚       â”‚   â”‚                                                 â”‚   â”‚ balance[3001]     â”‚
â”‚       â”‚   â”‚                                                 â”‚   â”‚    50 â†’ 60        â”‚
â”‚       â†“   â†“                                                 â†“   â†“                   â”‚
â”‚    âœ… Done!                                                âœ… Done!                 â”‚
â”‚       â”‚                                                     â”‚                       â”‚
â”‚       â”‚                                                     â”‚                       â”‚
â”‚       â”‚                                                     â†“                       â”‚
â”‚       â”‚                                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚       â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â· TwoPCPrepareReply â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ Success: true    â”‚             â”‚
â”‚       â”‚                                           â”‚ Message: preparedâ”‚             â”‚
â”‚       â”‚                                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚       â†“                                                                             â”‚
â”‚   Both Complete!                                                                    â”‚
â”‚   âœ… Coordinator Paxos done (seq=100)                                              â”‚
â”‚   âœ… Participant PREPARED (seq=200)                                                â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

STATE AFTER PREPARE:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cluster 1 (Coordinator)            â”‚ Cluster 2 (Participant)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Log[100] = {Phase:"P", executed}   â”‚ Log[200] = {Phase:"P", executed}   â”‚
â”‚ twoPCWAL[txnID][1001] = 100        â”‚ twoPCWAL[txnID][3001] = 50         â”‚
â”‚ balance[1001] = 90 (deducted)      â”‚ balance[3001] = 60 (credited)      â”‚
â”‚ item 1001 LOCKED ğŸ”’                â”‚ item 3001 LOCKED ğŸ”’                â”‚
â”‚ PrepareSeq = 100                   â”‚ PrepareSeq = 200                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    PHASE 2: COMMIT (SEQUENCE NUMBER REUSE!)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                                     â”‚
â”‚   Cluster 1 (C1)                              Cluster 2 (C2)                       â”‚
â”‚   Coordinator                                 Participant                           â”‚
â”‚                                                                                     â”‚
â”‚   â•”â•â•â•â•â•â•â•â•—                                                                         â”‚
â”‚   â•‘ Node 1â•‘                                                                         â”‚
â”‚   â•‘  ğŸ‘‘   â•‘                                                                         â”‚
â”‚   â•šâ•â•â•â•¤â•â•â•â•                                                                         â”‚
â”‚       â”‚                                                                             â”‚
â”‚       â”‚ Get PrepareSeq = 100                                                        â”‚
â”‚       â”‚                                                                             â”‚
â”‚       â†“                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                        â”‚
â”‚  â”‚ Phase=C â”‚                                                                        â”‚
â”‚  â”‚ Seq=100 â”‚ âš ï¸ REUSE! (not new)                                                   â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                                                        â”‚
â”‚       â”‚                                                                             â”‚
â”‚       â”‚ Update log[100].Phase = "C"                                                 â”‚
â”‚       â†“                                                                             â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•—                                                                    â”‚
â”‚  â•‘   ACCEPT    â•‘                                                                    â”‚
â”‚  â•‘  (Phase=C)  â•‘                                                                    â”‚
â”‚  â•‘  (Seq=100)  â•‘                                                                    â”‚
â”‚  â•šâ•â•â•â•â•â•â•¤â•â•â•â•â•â•â•                                                                    â”‚
â”‚       â”Œâ”€â”´â”€â”                                                                         â”‚
â”‚       â†“   â†“                                                                         â”‚
â”‚    Node2 Node3                                                                      â”‚
â”‚       â”‚   â”‚                                                                         â”‚
â”‚       â”‚   â”‚ Update Phase=C                                                          â”‚
â”‚       â”‚   â”‚ at seq=100                                                              â”‚
â”‚       â””â”€â”€â”€â”´â”€â†’ AcceptedReply                                                         â”‚
â”‚       â”‚                                                                             â”‚
â”‚       â”‚ âœ… Quorum                                                                   â”‚
â”‚       â†“                                                                             â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•—                                                                    â”‚
â”‚  â•‘   COMMIT    â•‘                                                                    â”‚
â”‚  â•‘  (Phase=C)  â•‘                                                                    â”‚
â”‚  â•‘  (Seq=100)  â•‘                                                                    â”‚
â”‚  â•šâ•â•â•â•â•â•â•¤â•â•â•â•â•â•â•                                                                    â”‚
â”‚       â”Œâ”€â”´â”€â”                                                                         â”‚
â”‚       â†“   â†“                                                                         â”‚
â”‚    Node2 Node3                                                                      â”‚
â”‚       â”‚   â”‚                                                                         â”‚
â”‚       â”‚   â”‚ handle2PCPhase("C")                                                     â”‚
â”‚       â”‚   â”‚ DELETE twoPCWAL                                                         â”‚
â”‚       â”‚   â”‚                                                                         â”‚
â”‚       â†“   â†“                                                                         â”‚
â”‚    âœ… Committed!                                                                    â”‚
â”‚       â”‚                                                                             â”‚
â”‚       â”‚                                                                             â”‚
â”‚   â•”â•â•â•â•§â•â•â•â•—                                                                         â”‚
â”‚   â•‘ Node 1â•‘â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â¸ TwoPCCommit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â•”â•â•â•â•â•â•â•â•—                   â”‚
â”‚   â•‘  ğŸ‘‘   â•‘                                             â•‘ Node 4â•‘                   â”‚
â”‚   â•šâ•â•â•â•â•â•â•â•                                             â•‘  ğŸ‘‘   â•‘                   â”‚
â”‚       â”‚                                                 â•šâ•â•â•â•¤â•â•â•â•                   â”‚
â”‚       â”‚                                                     â”‚                       â”‚
â”‚       â”‚                                                     â”‚ Get PrepareSeq = 200  â”‚
â”‚       â”‚                                                     â†“                       â”‚
â”‚       â”‚                                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚       â”‚                                                â”‚ Phase=C â”‚                 â”‚
â”‚       â”‚                                                â”‚ Seq=200 â”‚ âš ï¸ REUSE!      â”‚
â”‚       â”‚                                                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                 â”‚
â”‚       â”‚                                                     â”‚                       â”‚
â”‚       â”‚                                                     â”‚ Update log[200].Phaseâ”‚
â”‚       â”‚                                                     â†“                       â”‚
â”‚       â”‚                                                â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•—             â”‚
â”‚       â”‚                                                â•‘   ACCEPT    â•‘             â”‚
â”‚       â”‚                                                â•‘  (Phase=C)  â•‘             â”‚
â”‚       â”‚                                                â•‘  (Seq=200)  â•‘             â”‚
â”‚       â”‚                                                â•šâ•â•â•â•â•â•â•¤â•â•â•â•â•â•â•             â”‚
â”‚       â”‚                                                     â”Œâ”€â”´â”€â”                   â”‚
â”‚       â”‚                                                     â†“   â†“                   â”‚
â”‚       â”‚                                                  Node5 Node6               â”‚
â”‚       â”‚                                                     â”‚   â”‚                   â”‚
â”‚       â”‚                                                     â”‚   â”‚ Update Phase=C    â”‚
â”‚       â”‚                                                     â””â”€â”€â”€â”´â†’ AcceptedReply    â”‚
â”‚       â”‚                                                     â”‚                       â”‚
â”‚       â”‚                                                     â”‚ âœ… Quorum             â”‚
â”‚       â”‚                                                     â†“                       â”‚
â”‚       â”‚                                                â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•—             â”‚
â”‚       â”‚                                                â•‘   COMMIT    â•‘             â”‚
â”‚       â”‚                                                â•‘  (Phase=C)  â•‘             â”‚
â”‚       â”‚                                                â•‘  (Seq=200)  â•‘             â”‚
â”‚       â”‚                                                â•šâ•â•â•â•â•â•â•¤â•â•â•â•â•â•â•             â”‚
â”‚       â”‚                                                     â”Œâ”€â”´â”€â”                   â”‚
â”‚       â”‚                                                     â†“   â†“                   â”‚
â”‚       â”‚                                                  Node5 Node6               â”‚
â”‚       â”‚                                                     â”‚   â”‚                   â”‚
â”‚       â”‚                                                     â”‚   â”‚ handle2PCPhase("C")â”‚
â”‚       â”‚                                                     â”‚   â”‚ DELETE twoPCWAL   â”‚
â”‚       â”‚                                                     â†“   â†“                   â”‚
â”‚       â”‚                                                  âœ… Committed!              â”‚
â”‚       â”‚                                                     â”‚                       â”‚
â”‚       â”‚                                                     â”‚ Release lock 3001 ğŸ”“  â”‚
â”‚       â”‚                                                     â†“                       â”‚
â”‚       â”‚                                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚       â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â¹ TwoPCCommitReply â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ Success: true    â”‚             â”‚
â”‚       â”‚                                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚       â”‚                                                                             â”‚
â”‚       â†“                                                                             â”‚
â”‚  Release lock 1001 ğŸ”“                                                               â”‚
â”‚  Delete transaction state                                                          â”‚
â”‚  Cache result                                                                      â”‚
â”‚       â”‚                                                                             â”‚
â”‚       â†“                                                                             â”‚
â”‚   âœ… SUCCESS                                                                        â”‚
â”‚       â”‚                                                                             â”‚
â”‚       â†“                                                                             â”‚
â”‚      ğŸ‘¤                                                                             â”‚
â”‚    Client                                                                           â”‚
â”‚    (Reply: Success!)                                                                â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

FINAL STATE:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cluster 1 (Coordinator)            â”‚ Cluster 2 (Participant)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Log[100] = {Phase:"C"}             â”‚ Log[200] = {Phase:"C"}             â”‚
â”‚ twoPCWAL[txnID] = DELETED          â”‚ twoPCWAL[txnID] = DELETED          â”‚
â”‚ balance[1001] = 90                 â”‚ balance[3001] = 60                 â”‚
â”‚ item 1001 UNLOCKED ğŸ”“              â”‚ item 3001 UNLOCKED ğŸ”“              â”‚
â”‚ Transaction state DELETED          â”‚ Transaction state DELETED          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                         ABORT SCENARIO (IF PREPARE FAILS)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                                     â”‚
â”‚   Cluster 1 (C1)                              Cluster 2 (C2)                       â”‚
â”‚   Coordinator                                 Participant                           â”‚
â”‚                                                                                     â”‚
â”‚   â•”â•â•â•â•â•â•â•â•—                                        â•”â•â•â•â•â•â•â•â•—                       â”‚
â”‚   â•‘ Node 1â•‘â”€â”€â”€â”€â”€â”€ TwoPCPrepare â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ X â”€â”€â”€â”€â”€â•‘ Node 4â•‘                       â”‚
â”‚   â•‘  ğŸ‘‘   â•‘                                  FAIL  â•‘  ğŸ‘‘   â•‘                       â”‚
â”‚   â•šâ•â•â•â•¤â•â•â•â•                                        â•šâ•â•â•â•â•â•â•â•                       â”‚
â”‚       â”‚                                                                             â”‚
â”‚       â”‚ Participant PREPARE failed!                                                 â”‚
â”‚       â”‚ (e.g., item locked, timeout, etc.)                                          â”‚
â”‚       â”‚                                                                             â”‚
â”‚       â†“                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                        â”‚
â”‚  â”‚ Phase=A â”‚                                                                        â”‚
â”‚  â”‚ Seq=100 â”‚ âš ï¸ REUSE PrepareSeq                                                   â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                                                        â”‚
â”‚       â”‚                                                                             â”‚
â”‚       â†“                                                                             â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•—                                                                    â”‚
â”‚  â•‘   ACCEPT    â•‘                                                                    â”‚
â”‚  â•‘  (Phase=A)  â•‘                                                                    â”‚
â”‚  â•‘  (Seq=100)  â•‘                                                                    â”‚
â”‚  â•šâ•â•â•â•â•â•â•¤â•â•â•â•â•â•â•                                                                    â”‚
â”‚       â”Œâ”€â”´â”€â”                                                                         â”‚
â”‚       â†“   â†“                                                                         â”‚
â”‚    Node2 Node3                                                                      â”‚
â”‚       â”‚   â”‚                                                                         â”‚
â”‚       â”‚   â”‚ Update Phase=A                                                          â”‚
â”‚       â””â”€â”€â”€â”´â”€â†’ AcceptedReply                                                         â”‚
â”‚       â”‚                                                                             â”‚
â”‚       â†“                                                                             â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•—                                                                    â”‚
â”‚  â•‘   COMMIT    â•‘                                                                    â”‚
â”‚  â•‘  (Phase=A)  â•‘                                                                    â”‚
â”‚  â•šâ•â•â•â•â•â•â•¤â•â•â•â•â•â•â•                                                                    â”‚
â”‚       â”Œâ”€â”´â”€â”                                                                         â”‚
â”‚       â†“   â†“                                                                         â”‚
â”‚    Node2 Node3                                                                      â”‚
â”‚       â”‚   â”‚                                                                         â”‚
â”‚       â”‚   â”‚ handle2PCPhase("A")                                                     â”‚
â”‚       â”‚   â”‚ ROLLBACK using WAL                                                      â”‚
â”‚       â”‚   â”‚ balance[1001] = 100 (restore!)                                          â”‚
â”‚       â”‚   â”‚ DELETE twoPCWAL                                                         â”‚
â”‚       â†“   â†“                                                                         â”‚
â”‚    âœ… Rolled back!                                                                  â”‚
â”‚       â”‚                                                                             â”‚
â”‚       â”‚                                                                             â”‚
â”‚   â•”â•â•â•â•§â•â•â•â•—                                                                         â”‚
â”‚   â•‘ Node 1â•‘â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ TwoPCAbort â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â•”â•â•â•â•â•â•â•â•—                    â”‚
â”‚   â•‘  ğŸ‘‘   â•‘           (reason: prepare failed)        â•‘ Node 4â•‘                    â”‚
â”‚   â•šâ•â•â•â•â•â•â•â•                                            â•‘  ğŸ‘‘   â•‘                    â”‚
â”‚       â”‚                                                â•šâ•â•â•â•¤â•â•â•â•                    â”‚
â”‚       â”‚                                                    â”‚                        â”‚
â”‚       â†“                                                    â”‚ (if locked anything)   â”‚
â”‚  Release lock 1001 ğŸ”“                                      â”‚ Rollback & release     â”‚
â”‚  Delete transaction state                                 â†“                        â”‚
â”‚       â”‚                                                âœ… Aborted                   â”‚
â”‚       â†“                                                                             â”‚
â”‚   âŒ FAILED                                                                         â”‚
â”‚       â”‚                                                                             â”‚
â”‚       â†“                                                                             â”‚
â”‚      ğŸ‘¤                                                                             â”‚
â”‚    Client                                                                           â”‚
â”‚    (Reply: Failed!)                                                                 â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                           KEY VISUAL ELEMENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Symbols Used:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚  ğŸ‘‘     Leader node (crown)
â”‚  â–“      Active/leader node (shaded)
â”‚  ğŸ”’     Lock acquired
â”‚  ğŸ”“     Lock released
â”‚  âœ…     Success / Complete
â”‚  âŒ     Failure / Abort
â”‚  X      Error / Failed operation
â”‚  ğŸ‘¤     Client
â”‚  â•â•â•    Paxos consensus box (double line)
â”‚  â”€â”€â”€    Regular flow line
â”‚  â†“ â†‘    Message direction
â”‚  â¶â·â¸â¹  Step numbers

Clusters:
â”€â”€â”€â”€â”€â”€â”€â”€â”€
Each cluster has 3 nodes for quorum (majority = 2/3)
Leader marked with ğŸ‘‘
Followers participate in consensus

Phases:
â”€â”€â”€â”€â”€â”€â”€
Phase=P  PREPARE (transaction execution happens here!)
Phase=C  COMMIT (just marks as permanent, execution already done)
Phase=A  ABORT (rollback using WAL)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                      CRITICAL FEATURES VISUALIZED
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. PARALLEL EXECUTION (PREPARE Phase)
   â€¢ Coordinator's Paxos runs in parallel with
   â€¢ Sending PREPARE to participant
   â€¢ Both must complete before proceeding

2. SEQUENCE NUMBER REUSE
   â€¢ PREPARE allocates: seq=100
   â€¢ COMMIT reuses: seq=100 (not new!)
   â€¢ ABORT reuses: seq=100 (if needed)

3. WAL ON ALL NODES
   â€¢ Not just leader
   â€¢ Followers also save twoPCWAL
   â€¢ Enables rollback even after leader failure

4. PHASE MARKERS EVERYWHERE
   â€¢ Every ACCEPT has phase="P"/"C"/"A"
   â€¢ Every COMMIT has phase
   â€¢ All nodes see and handle phases

5. LOCK MANAGEMENT
   â€¢ Coordinator locks sender item
   â€¢ Participant locks receiver item
   â€¢ Released only after COMMIT/ABORT complete

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                          MESSAGE FLOW SUMMARY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Client â†’ Coordinator:
  TransactionRequest (1001â†’3001:10)

Coordinator â†’ Participant:
  â¶ TwoPCPrepareRequest (txnID, transaction, clientID, timestamp)

Participant â†’ Coordinator:
  â² TwoPCPrepareReply (success, txnID, message)

Coordinator â†’ Participant:
  â¸ TwoPCCommitRequest (txnID)

Participant â†’ Coordinator:
  â¹ TwoPCCommitReply (success, txnID)

Coordinator â†’ Client:
  TransactionReply (success, result)

If abort needed:
  Coordinator â†’ Participant: TwoPCAbortRequest (txnID, reason)
  Participant â†’ Coordinator: TwoPCAbortReply (success, txnID)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        âš ï¸  THE BUG TO FIX
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Current code (line 80 in twopc.go):
    receiverLeader := n.config.GetLeaderNodeForCluster(receiverCluster)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                      STATIC! Returns configured leader (e.g., Node 4)

But actual leader might be Node 5 (after election)!

Coordinator sends to Node 4 â†’ Node 4 can't get quorum â†’ Transaction fails âŒ

Your task: Implement dynamic leader discovery! ğŸ¯

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

## Diagram Legend

### Node States
- **â–“ (Shaded)**: Leader node (active)
- **ğŸ‘‘ (Crown)**: Leader designation
- **Empty**: Follower node

### Message Flow
- **â”€â”€â”€â†’**: Regular message/RPC
- **â•â•â•**: Paxos consensus boundary
- **â†“/â†‘**: Direction of flow
- **â¶â·â¸â¹**: Numbered steps in sequence

### Lock States
- **ğŸ”’**: Lock acquired
- **ğŸ”“**: Lock released

### Results
- **âœ…**: Success/Complete
- **âŒ**: Failure/Abort
- **X**: Error condition

This visual diagram shows the complete 2PC flow with parallel execution, phase markers, sequence reuse, and WAL management across all nodes!
